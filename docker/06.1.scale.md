[Назад](./questions.md)

### Что такое оркестрация?

Это процесс автоматизации развертывания, управления, масштабирования и координации контейнеризированных приложений. 
Она решает задачи управления большим количеством контейнеров в сложных распределённых системах, обеспечивая надёжность 
и отказоустойчивость.

Когда приложение становится сложным и состоит из множества микросервисов, каждый из которых работает в собственном 
контейнере, ручное управление такими системами становится практически невозможным. Оркестрация автоматизирует эти 
процессы, улучшает отказоустойчивость системы и упрощает масштабирование.

#### Основные функции оркестрации:

1. **Автоматическое развертывание и управление контейнерами:** Оркестрация позволяет автоматически разворачивать 
контейнеры на кластере серверов. Если один контейнер выйдет из строя, оркестратор перезапустит его или развернёт 
новую копию.
2. **Масштабирование контейнеров:** Оркестраторы позволяют легко масштабировать контейнеры — увеличивать или уменьшать 
их количество в зависимости от нагрузки на систему. Это можно делать вручную или автоматически на основе метрик 
(например, загруженности CPU или памяти).
3. **Балансировка нагрузки:** Оркестраторы распределяют входящие запросы между запущенными контейнерами, чтобы нагрузка 
на систему была равномерно распределена. Это помогает поддерживать высокую производительность и доступность приложения.
4. **Мониторинг состояния контейнеров:** Оркестраторы постоянно отслеживают состояние контейнеров и перезапускают их в 
случае сбоев. Это позволяет поддерживать непрерывную работу приложения без вмешательства человека.
5. **Управление сетью:** Оркестраторы создают внутренние сети для контейнеров, чтобы они могли безопасно и эффективно 
взаимодействовать между собой. Они управляют маршрутизацией трафика, создают виртуальные сети и обеспечивают доступ к 
контейнерам извне.
6. **Обновление и откаты:** Оркестрация позволяет безопасно обновлять приложения с минимальным простоем. Сервисы можно 
обновлять поэтапно, чтобы в случае ошибок быстро откатиться на предыдущую версию.
7. **Безопасность:** Оркестраторы управляют доступом к контейнерам, поддерживают изоляцию на уровне сети и ресурсов, 
а также интегрируются с системами контроля прав и аутентификации.

### Что такое Docker Swarm?

Это встроенный в Docker инструмент для оркестрации контейнеров, который позволяет управлять распределёнными кластерами 
Docker-контейнеров. С помощью Docker Swarm можно запускать, масштабировать и управлять контейнерами на множестве серверов, 
которые объединены в единый кластер. Swarm упрощает управление контейнерами и автоматизирует их координацию и балансировку 
нагрузки.

### Как масштабировать Docker контейнеры?

1. **Масштабирование через Docker Compose**
   - Для этого в файле `docker-compose.yml` нужно определить сервис, который необходимо масштабировать.
    ```yaml
    version: '3'
    services:
      web:
        image: nginx
        ports:
          - "80:80"
    ```
   - Чтобы масштабировать сервис (например, `web`) на несколько экземпляров, можно воспользоваться командой:
   ```bash
   docker-compose up --scale web=3
   # Эта команда запустит три контейнера сервиса web.
   ```
2. **Масштабирование с помощью Docker Swarm** - это встроенная система оркестрации контейнеров в Docker, 
которая позволяет легко управлять кластерами и масштабировать сервисы.
   - Сначала инициализируйте кластер Swarm:
   ```bash
   docker swarm init
   ```
   - Затем создайте и разверните сервис с масштабированием:
   ```bash
   docker service create --name web --replicas 5 -p 80:80 nginx
   # Это создаст сервис web с пятью репликами контейнера Nginx.
   ```
   - Масштабировать уже запущенный сервис можно с помощью команды:
   ```bash
   docker service scale web=10
   # Эта команда масштабирует сервис до 10 экземпляров контейнера.
   ```
3. **Масштабирование с помощью Kubernetes** - Kubernetes (K8s) — один из самых популярных инструментов 
оркестрации контейнеров, который предоставляет мощные механизмы для автоматического масштабирования.
- Для этого сначала необходимо настроить кластер Kubernetes и создать манифест для деплоя (например, nginx-deployment.yaml):
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
```
- Разверните Deployment с помощью команды:
```bash
kubectl apply -f nginx-deployment.yaml
```
- Kubernetes автоматически управляет количеством реплик через контроллеры, и чтобы изменить количество реплик, используйте:
```bash
kubectl scale deployment nginx-deployment --replicas=5
```
- Kubernetes также поддерживает автоматическое горизонтальное масштабирование (Horizontal Pod Autoscaler, HPA), 
которое увеличивает или уменьшает количество реплик в зависимости от загрузки CPU или других метрик. 
Пример автоматического масштабирования:
```bash
kubectl autoscale deployment nginx-deployment --cpu-percent=50 --min=1 --max=10
#  Это автоматически будет масштабировать количество подов от 1 до 10 в зависимости от загрузки CPU.
```

### Загрузка балансировки и отказоустойчивость

Масштабирование должно сопровождаться балансировкой нагрузки для равномерного распределения трафика между контейнерами. 
В Docker `Swarm` и `Kubernetes` это делается автоматически, но для Docker Compose можно вручную настроить прокси-серверы 
или использовать внешние решения, такие как NGINX.

Пример настройки NGINX как балансировщика нагрузки для нескольких контейнеров:
```nginx
http {
    upstream backend {
        server 127.0.0.1:8081;
        server 127.0.0.1:8082;
        server 127.0.0.1:8083;
    }

    server {
        location / {
            proxy_pass http://backend;
        }
    }
}
```

### Сопутствующие разделы

- [Что такое Dockerfile?](./04.1.dockerfile.md)
- [Что такое Docker Compose?](./04.2.docker-compose.md)
- [Как работает система тегов для Docker образов?](./05.1.tags.md)
- [Как подключить внешние файлы к контейнеру?](./05.2.volume.md)
- [Что такое Network в Docker?](./06.2.network.md)
- [Что такое Docker Swarm?](./06.3.swarm.md)
