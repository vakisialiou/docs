[Назад](./questions.md)

### Что такое Docker Compose?

**Docker Compose** — это инструмент для запуска и управления многоконтейнерными приложениями в Docker с помощью 
единого файла конфигурации. Он позволяет описывать сервисы (контейнеры), сети, тома и другие параметры в файле 
`docker-compose.yml`, а затем запускать все сервисы одновременно с помощью одной команды.

### Основные возможности

1. **Определение многоконтейнерных приложений:** Вместо запуска каждого контейнера вручную, вы можете описать всю 
архитектуру приложения в одном файле `docker-compose.yml`. Например, можно задать веб-сервер, базу данных и 
кэш-систему как разные сервисы.
2. **Управление зависимостями контейнеров:** Compose позволяет задавать зависимости между контейнерами. 
Например, можно указать, что база данных должна запускаться перед веб-сервером.
3. **Работа с сетями и томами:** Compose автоматически создаёт нужные сети для взаимодействия контейнеров и тома 
для хранения данных. Это делает настройку инфраструктуры проще и более гибкой.
4. **Одна команда для управления всеми контейнерами:** Вместо того чтобы запускать, останавливать и перезапускать 
контейнеры по отдельности, Compose позволяет управлять всеми сервисами через одну команду, например, 
`docker-compose up` для запуска или `docker-compose down` для остановки.

### Основные команды Docker Compose

1. `up` - Запуск всех сервисов, описанных в `docker-compose.yml`. Если образы не найдены локально, 
они будут загружены из `Docker Hub` или собраны.
    ```bash
    docker-compose up
    # для запуска в фоновом режиме можно добавить флаг -d (detached mode)
    docker-compose up -d
    ```
2. `down` - Остановка всех запущенных сервисов и удаление их контейнеров, сетей и временных томов, 
созданных с помощью Docker Compose.
    ```bash
    docker-compose down
    ```
3. `ps` - Просмотр текущего состояния запущенных контейнеров.
    ```bash
    docker-compose ps
    ```
4. `logs` - Просмотр логов всех контейнеров, запущенных с помощью Compose.
    ```bash
    docker-compose logs
    ```
5. `build` - Сборка образов, если в файле docker-compose.yml используется локальный Dockerfile.
    ```bash
    docker-compose build
    ```
6. `--scale` - Масштабирование.
    ```bash
    docker-compose up --scale web=3
    ```


### Какие основные директивы используются в Docker Compose?

1. `version` - Указывает версию файла конфигурации Compose. Это необходимо для обеспечения совместимости с 
различными версиями Docker Compose.
    ```yaml
    version: '3.8'
    ```
2. `services` - Основная директива, описывающая все контейнеры (сервисы) приложения и их конфигурации.
    ```yaml
    services:
      web:
        image: nginx
        ports:
          - "8080:80"
      db:
        image: postgres
        environment:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
    ```
3. `version` - Определяет Docker-образ, который будет использован для создания контейнера.
    ```yaml
    image: nginx:latest
    ```
4. `build` - Указывает путь к Dockerfile для сборки образа из исходного кода. Это может быть либо путь к 
директории, либо дополнительные параметры для сборки.
    ```yaml
    build: ./app
    ```
   ```yaml
    build:
    context: ./app
    dockerfile: Dockerfile.dev
    ```
5. `ports` - Пробрасывает порты из контейнера на хост. Формат `HOST:CONTAINER`.
    ```yaml
    ports:
      - "8080:80"
   ```
6. `volumes` - Описывает тома для хранения данных. Может быть как привязка локальной директории, так и 
создание именованных томов.
    ```yaml
    # Пример привязки локальной директории
    volumes:
      - ./data:/var/lib/mysql
   ```
    ```yaml
    # Пример использования именованного тома
    volumes:
      - db-data:/var/lib/postgresql/data
   ```
7. `environment` - Определяет переменные окружения для контейнера.
    ```yaml
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ```
8. `networks` - Указывает сети, которые будут использоваться контейнерами. Сетевые настройки позволяют 
организовывать взаимодействие между сервисами.
    ```yaml
    networks:
      my-network:
    services:
      web:
        image: nginx
        networks:
          - my-network
      db:
        image: postgres
        networks:
          - my-network
    ```
9. `depends_on` - Задаёт зависимости между сервисами, указывая, что один сервис должен быть запущен до другого.
    ```yaml
    services:
      web:
        image: nginx
        depends_on:
          - db
      db:
        image: postgres
    ```
10. `command` - Определяет команду, которая будет выполнена при запуске контейнера, заменяя команду по умолчанию 
из Dockerfile.
    ```yaml
    command: python app.py
    ```
11. `restart` - Указывает политику перезапуска контейнера при его завершении или сбое. Опции:
    - **no:** Контейнер не перезапускается (по умолчанию).
    - **always:** Контейнер перезапускается всегда.
    - **on-failure:** Перезапуск происходит только при ошибках.
    - **unless-stopped:** Контейнер перезапускается, пока не будет явно остановлен.
    ```yaml
    restart: always
    ```
12. `depends_on` - Указывает порядок запуска сервисов. Сервисы, указанные в depends_on, будут запущены перед тем, 
как будет запущен текущий сервис.
    ```yaml
    depends_on:
      - db
      - redis
    ```
13. `entrypoint` - Позволяет задать команду, которая будет выполнена при старте контейнера. Эта команда может 
переопределять ту, что указана в Dockerfile.
    ```yaml
    entrypoint: /app/entrypoint.sh
    ```
14. `volumes` - Описывает привязку томов к контейнерам для постоянного хранения данных или совместного 
использования данных между контейнерами.
    - `db-data` - Привязка именованного тома к каталогу `/var/lib/postgresql/data` внутри контейнера для сохранения 
    данных базы.
    - `./html` - Привязка локальной директории `./html` к каталогу `/usr/share/nginx/html` в контейнере, чтобы 
    хранить статические файлы веб-сайта.
    ```yaml
    services:
      db:
        image: postgres
        volumes:
          - db-data:/var/lib/postgresql/data
        environment:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
    
      web:
        image: nginx
        ports:
          - "8080:80"
        volumes:
          - ./html:/usr/share/nginx/html
    
    volumes:
      db-data:
    ```
15. `expose` - Указывает порты контейнера, которые нужно сделать доступными для других контейнеров в сети. 
Это внутренние порты, а не внешние порты на хосте, как в `ports`
    ```yaml
    expose:
      - "5432"
    ```
16. `healthcheck` - Настраивает проверки состояния контейнера, чтобы убедиться, что он работает корректно.
    ```yaml
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 1m30s
      timeout: 10s
      retries: 3
    ```
17. `tty` - Указывает, должен ли Docker запустить контейнер с поддержкой псевдотерминала (обычно для 
интерактивных приложений).
    ```yaml
    tty: true
    ```

###  Что такое псевдотерминал?

Это интерфейс, который предоставляет программам возможность взаимодействовать с терминалом так, как если бы 
они имели дело с реальным физическим терминалом, хотя на самом деле это виртуальный терминал, симулируемый 
операционной системой.

В контексте Docker и опции `tty: true` в Docker Compose или команды `docker run -t`, псевдотерминал создаёт 
эмуляцию терминала для контейнера, что позволяет программам, запущенным внутри контейнера, работать в 
интерактивном режиме, как если бы они были запущены в реальном терминале. Например, это полезно для 
взаимодействия с оболочками (shell) или программами, которые требуют терминала для правильного функционирования 
(например, текстовые редакторы).

### Как работать с переменными окружения (environment variables) в Docker Compose?

В Docker Compose переменные окружения (environment variables) позволяют настраивать конфигурацию контейнеров, 
передавая значения, которые могут использоваться внутри контейнеров для настройки приложений. Эти переменные 
можно задавать в файле `docker-compose.yml`, передавать через `.env` файлы, либо объявлять их на уровне системы.

1. **Использование директивы `environment` в `docker-compose.yml`** - Переменные окружения можно напрямую указать 
для конкретного сервиса в секции `environment`.
    ```yaml
    version: '3.8'
    
    services:
      app:
        image: myapp
        environment:
          - APP_ENV=production
          - DEBUG=false
        ports:
          - "8080:80"
    ```
    - Здесь переменные `APP_ENV` и `DEBUG` будут доступны внутри контейнера как переменные окружения.
    ```bash
    version: '3.8'
    
    services:
      app:
        image: myapp
        environment:
          # альтернативный синтаксис
          APP_ENV: production
          DEBUG: false
        ports:
          - "8080:80"
    ```
2. **Использование файла `.env`** - Docker Compose автоматически подхватывает переменные из файла `.env`, 
расположенного в той же директории, что и `docker-compose.yml`. Переменные в этом файле можно использовать как в 
настройках Compose-файла, так и в контейнерах.
   - Пример файла `.env`:
    ```
    APP_ENV=production
    DEBUG=false
    ```
   - Пример `docker-compose.yml`, который использует переменные из `.env` файла:
    ```yaml
    version: '3.8'
    
    services:
      app:
        image: myapp
        environment:
          - APP_ENV=${APP_ENV}
          - DEBUG=${DEBUG}
        ports:
          - "8080:80"
    ```
3. **Передача переменных окружения через системные переменные** - Если переменная окружения уже установлена в системе, 
Docker Compose может её подхватить. В файле `docker-compose.yml` можно использовать синтаксис `${VARIABLE_NAME}` для 
получения значения переменной окружения.
    ```yaml
    version: '3.8'
    
    services:
     app:
       image: myapp
       environment:
         - DATABASE_URL=${DATABASE_URL}
       ports:
         - "8080:80"
    ```
4. **Использование файла с переменными окружения через директиву `env_file`** - Можно загрузить переменные окружения 
из внешнего файла, используя директиву `env_file`. Этот файл имеет тот же формат, что и `.env`, но его можно явно 
указать в `docker-compose.yml`.
    ```yaml
    version: '3.8'
    
    services:
      app:
        image: myapp
        env_file:
          - ./config/app.env
        ports:
          - "8080:80"
    ```
5. **Чувствительные данные и переменные окружения** - Если необходимо передать чувствительные данные, такие как пароли, 
можно использовать переменные окружения вместе с файлами секретов или же ограничить доступ к файлам `.env`.
    ```yaml
    version: '3.8'
    
    services:
      db:
        image: postgres
        environment:
          POSTGRES_USER: ${DB_USER}
          POSTGRES_PASSWORD: ${DB_PASSWORD}
        env_file:
          - .env
    ```
6. **Переопределение значений переменных** - Переменные окружения в Docker Compose можно переопределять несколькими способами, 
в зависимости от порядка их объявления
- Переменные в `docker-compose.yml` имеют приоритет над значениями из `.env`.
- Если в системе заданы переменные окружения, они могут переопределить значения из .env.

### Сопутствующие разделы

- [Что такое оркестрация?](./06.1.scale.md)
- [Что такое DockerFile?](./04.1.dockerfile.md)
- [Как подключить внешние файлы к контейнеру?](./05.2.volume.md)
- [Как работает система тегов для Docker образов?](./05.1.tags.md)
- [Что такое оркестрация?](./06.1.scale.md)
