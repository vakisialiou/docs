
### Что такое Middleware в Next.js и как его можно использовать?

`Middleware` - это функция, которая выполняется перед обработкой запросов на сервере. Он позволяет 
выполнять код, проверять условные операторы, изменять запросы и ответы, а также управлять маршрутами, 
что делает его мощным инструментом для управления поведением приложения на серверной стороне.

`Middleware` устанавливается в специальном файле, названном `middleware.js` или `middleware.ts`, 
который располагается в корневой директории проекта или в папке `app`.

1. Создайте файл `middleware.js` в корне проекта или в папке `app`.
    ```javascript
    // middleware.js
    import { NextResponse } from 'next/server'
    
    export function middleware(request) {
      if (request.nextUrl.pathname.startsWith('/admin')) {
        // Проверяем наличие токена в заголовках запроса
        const token = request.headers.get('Authorization')
    
        // Если токен отсутствует, перенаправляем на страницу входа
        if (!token) {
          return NextResponse.redirect(new URL('/login', request.url))
        }
      }
    
      // Если токен есть, продолжаем выполнение запроса
      return NextResponse.next()
    }
    ```
2. Настройка `Middleware` (необязательно)
   - Вы можете настроить `Middleware` так, чтобы он применялся только к определенным маршрутам или путям. 
   Для этого можно использовать свойства `config`.
    ```javascript
    export const config = {
      matcher: ['/admin/:path*'], // Применять Middleware только для защищенных маршрутов
    }
    ```

### Что такое App Router и какие улучшения он приносит в Next.js по сравнению с Page Router?

`App Router` в Next.js представляет собой новый подход к маршрутизации, который был представлен в версии 13. 
Он заменяет традиционный `Page Router`, предлагая более гибкие и мощные возможности для организации и управления 
маршрутами в приложении.

1. **Упрощенная навигация:** - `App Router` делает навигацию более интуитивно понятной и удобной благодаря 
автоматическому созданию маршрутов на основе структуры папок и файлов.
   - **App Router:** Создание вложенных маршрутов осуществляется через простую файловую структуру, которая 
   позволяет автоматически генерировать маршруты.
    ```plantuml
    app/
    ├── dashboard/
    │   └── page.js   // /dashboard
    └── page.js       // /
    ```
   - **Page Router:** Необходимо вручную управлять маршрутами в файле `next.config.js`, это требует больше кода и 
   конфигурации.
2. **Повышенная производительность:** - Использование `React Server Components` в `App Router` позволяет сократить 
объем передаваемого кода и повысить скорость загрузки страниц, так как сервер рендерит только необходимые компоненты.
3. **Улучшенное управление состоянием:** - `App Router` упрощает управление состоянием на уровне страниц и 
компонентов, позволяя использовать локальные состояния в компонентах без необходимости передавать их через пропсы.
4. **Гибкость в организации кода:** - Благодаря поддержке вложенных маршрутов и общей структуры папок, код становится 
более организованным и удобным для понимания.
5. **Интеграция с существующими функциями:** - `App Router` интегрируется с такими функциями, как API маршруты, 
динамическая маршрутизация и статическая генерация, что делает его универсальным инструментом для создания современных 
веб-приложений.

### Как настроить кастомный сервер в Next.js?

В Next.js можно настроить кастомный сервер для управления маршрутами, обработки запросов или добавления кастомной 
логики перед рендерингом. Это может быть полезно, если вам нужно больше контроля над сервером, например, для интеграции 
с другим фреймворком или middleware. Однако стоит отметить, что кастомные серверы часто не нужны, так как Next.js 
предоставляет большинство возможностей "из коробки".

#### Настройка кастомного сервера:

1. **Установка Next.js и зависимостей:** Убедитесь, что установлен например `express`.
    ```bash
    npm install express
    ```
2. **Создание кастомного сервера:** Вместо использования встроенного сервера Next.js, создается файл для кастомного 
сервера, например `server.js`
    ```javascript
    // server.js
    const express = require('express')
    const next = require('next')
    
    const dev = process.env.NODE_ENV !== 'production'
    const app = next({ dev })
    const handle = app.getRequestHandler()
    
    app.prepare().then(() => {
      const server = express()
    
      // Кастомные маршруты
      server.get('/p/:id', (req, res) => {
        const actualPage = '/post'
        const queryParams = { id: req.params.id }
        app.render(req, res, actualPage, queryParams)
      })
    
      // Обработка всех остальных маршрутов через Next.js
      server.all('*', (req, res) => {
        return handle(req, res)
      })
    
      // Запуск сервера
      server.listen(3000, (err) => {
        if (err) {
            throw err
        }    
        console.log('> Ready on http://localhost:3000')
      })
    })
    ```
3. **Запуск кастомного сервера:** Теперь необходимо изменить скрипт запуска приложения в `package.json`, чтобы запускать 
кастомный сервер вместо стандартного.
    ```json
    {
      "scripts": {
        "dev": "node server.js",
        "start": "NODE_ENV=production node server.js"
      }
    }
    ```
    ```bash
    npm run dev
    ```
4. **Использование кастомных маршрутов:** В приведенном выше примере настроен кастомный маршрут `/p/:id`, который рендерит 
страницу `post.js`, передавая параметр `id`.
    ```javascript
    // pages/post.js
    export default function Post({ id }) {
      return <div>Post ID: {id}</div>;
    }
    ```
   Теперь при переходе на маршрут `/p/123`, Next.js отрендерит страницу `post.js` с параметром `id = 123`.

#### Зачем использовать кастомный сервер?

1. **Кастомные маршруты:** Если вам нужны маршруты, которые отличаются от файловой системы Next.js.
2. **Middleware:** Вы можете интегрировать `middleware` (например, для аутентификации, логирования запросов или обработки ошибок).
3. **Интеграция с другими фреймворками:** Например, если вам нужно соединить Next.js с Express или любым другим фреймворком.
4. **Интеграция с API:** Если вам нужно настроить API или иные серверные запросы, которые не обрабатываются встроенным API Next.js.

Настройка кастомного сервера в Next.js предоставляет больше контроля над маршрутизацией и серверной логикой, но это также 
добавляет сложности в конфигурации и поддержке. Стандартный сервер Next.js уже предлагает много возможностей "из коробки", 
поэтому кастомный сервер требуется в более специфичных случаях.

